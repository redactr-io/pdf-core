FROM python:3.12-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends tesseract-ocr tesseract-ocr-eng && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install dependencies (cached unless pyproject.toml changes)
COPY pyproject.toml .
RUN mkdir -p src/pdf_service && touch src/pdf_service/__init__.py && \
    pip install --no-cache-dir ".[test]"

# Copy source, tests, and proto
COPY src/ src/
COPY tests/ tests/
COPY proto/ proto/

# Generate proto stubs and fix imports
RUN pip install --no-cache-dir "grpcio-tools>=1.68.0" && \
    python -m grpc_tools.protoc \
        -Iproto \
        --python_out=src/pdf_service/generated \
        --grpc_python_out=src/pdf_service/generated \
        --pyi_out=src/pdf_service/generated \
        proto/redactr/pdf/v1/pdf_service.proto && \
    python -c "import glob, re, pathlib; \
        [pathlib.Path(f).write_text(re.sub(r'from redactr\.pdf\.v1', 'from pdf_service.generated.redactr.pdf.v1', pathlib.Path(f).read_text())) \
        for f in glob.glob('src/pdf_service/generated/redactr/pdf/v1/*.py')]"

# Reinstall package with generated stubs
RUN pip install --no-cache-dir ".[test]" --no-deps --force-reinstall

CMD ["pytest", "tests/e2e", "-v"]
